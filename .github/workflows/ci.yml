name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Set up vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: b1b19307e2d2ec1eefbdb7ea069de7d4bcd31f01

      - name: Configure
        run: cmake --preset default

      - name: Build managed WPF assembly
        run: msbuild src/tap_wpf/LvtWpfTap.csproj /p:Configuration=Release /p:Platform=AnyCPU /restore /v:minimal

      - name: Build
        run: cmake --build build

      - name: Unit tests
        run: build\lvt_unit_tests.exe --gtest_output=xml:build\unit_test_results.xml

      - name: Integration tests
        run: build\lvt_integration_tests.exe --gtest_output=xml:build\integration_test_results.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: build\*_test_results.xml

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lvt-binaries
          path: |
            build/lvt.exe
            build/lvt_tap_x64.dll
            build/lvt_wpf_tap_x64.dll
            build/LvtWpfTap.dll
